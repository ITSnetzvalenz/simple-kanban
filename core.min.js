(function(){"use strict";var e={people:{}};var t=false;var n=function(){var t=s(possibleStates);$.ajax({type:"POST",url:"server.php",data:{action:"load"},dataType:"json",success:function(n){if(n===null){n={}}e.board=o(n);e.states=t.states;e.states_order=t.states_order;e.rawData=n;l(e);r()}})};var r=function(){var t='<form ><ul class="people-list">';for(var n in e.people){if(e.people.hasOwnProperty(n)){t+='<li><input type="checkbox" name="'+n+'">'+n+"</li>"}}t+="</ul></form>";$("#navigation").append(t)};var i=function(e){if(e===""){e={}}$.ajax({type:"POST",url:"server.php",data:{action:"save",data:e},dataType:"json"})};var s=function(e){var t={};var n=[];for(var r=0,i=e.length;r<i;r++){var s=e[r].split(",");if(s.length===2){t[s[0]]=s[1];n.push(s[0])}}return{states:t,states_order:n}};var o=function(e){var t={};for(var n in e){if(e.hasOwnProperty(n)){var r=e[n];r.id=n;if(!t[r.state]){t[r.state]=[]}t[r.state].push(r)}}return t};var u=function(t){var n=$("<li data-state='"+t.state+"' data-id='"+t.id+"'><div class='box color_"+t.color+"' ><div class='editable' data-id='"+t.id+"'>"+t.title+", "+t.responsible+"</div></div></li>");if(e.people[t.responsible]===undefined){e.people[t.responsible]=[t.id]}else{e.people[t.responsible].push(t.id)}return n};var a=function(t,n){var r=$("<ul></ul>");if(t[n]){for(var i=0,s=t[n].length;i<s;i++){var o=t[n][i].id;var a=u(e.rawData[o]);r.append(a)}}return"<ul class='state' id='"+n+"'>"+r.html()+"</ul>"};var f=function(e,t,n,r){var i='<div class="col state_box state_'+t+" col_"+r+'"><h4>'+n+"</h4>";i+=a(e,t);i+="</div>";return i};var l=function(e){for(var t=0;t<e.states_order.length;t++){var n=e.states_order[t];var r=f(e.board,n,e.states[n],t);$("#board").append(r)}$("ul.state").dragsort({dragSelector:"li",dragBetween:true,placeHolderTemplate:"<li class='placeholder'><div>Â </div></li>",dragEnd:h})};var c=function(t,n,r,i){if(r===undefined){r=e.states_order[0]}if(i===undefined){i=0}var s=n.split(",");if(s.length===1){s[1]="tbd"}var o={title:s[0],id:t,responsible:s[1].replace(/^\s+/,""),state:r,color:i};return o};var h=function(){var t=$(this).parent().attr("id");var n=$(this).attr("data-id");e.rawData[n].state=t;i(e.rawData)};$(document).ready(function(){n();$("#new").click(function(){var t=(new Date).getTime();var n=c(t,"New project");if(e.rawData===undefined){e.rawData={}}e.rawData[t]=n;i(e.rawData);var r=u(n);$("#"+n.state).append(r);return false});$("#board").on("click",".editable",function(){if(!t){var e=$(this).html();var n='<form><input type="text" class="editBox" value="'+e+'" data-old-value="'+e+'"/><br/><a class="save" href="#">save</a> <a class="cancel" href="#">cancel</a> <a href="#" class="delete">delete</a> <a href="#" class="color">color</a></form>';$(this).html(n);t=true}});$("#navigation").on("change",".people-list li",function(){var t=$(this).find("input").attr("name");for(var n in e.people[t]){if($('#board li[data-id="'+e.people[t][n]+'"]').hasClass("highlight")){$('#board li[data-id="'+e.people[t][n]+'"]').removeClass("highlight")}else{$('#board li[data-id="'+e.people[t][n]+'"]').addClass("highlight")}}});$(document).keyup(function(e){if(e.keyCode===27){$(".cancel").trigger("click")}else if(e.keyCode===78){$("#new").trigger("click")}});$("#board").on("click",".cancel",function(){var e=$(this).parent().find("input").attr("data-old-value");$(this).parent().parent().html(e);setTimeout(function(){t=false},200);return false});$("#board").on("click",".delete",function(){var n=$(this).parent().parent().attr("data-id");$(this).parent().parent().parent().parent().remove();delete e.rawData[n];i(e.rawData);setTimeout(function(){t=false},200);return false});$("#board").on("click",".color",function(){var t=$(this).parent().parent().attr("data-id");if(e.rawData[t].color===undefined){e.rawData[t].color=0}else{$(this).parent().parent().parent().removeClass("color_"+e.rawData[t].color);e.rawData[t].color++;if(e.rawData[t].color>=possible_colors){e.rawData[t].color=0}}$(this).parent().parent().parent().addClass("color_"+e.rawData[t].color);return false});$("#board").on("submit","form",function(){var n=$(this).find("input").val();var r=$(this).parent().attr("data-id");var s=$(this).parent().parent().parent().attr("data-state");var o=c(r,n,s,e.rawData[r].color);e.rawData[r]=o;i(e.rawData);$(this).parent().html(o.title+", "+o.responsible);setTimeout(function(){t=false},200);return false});$("#board").on("click",".save",function(){$(this).parent().submit();return false})})})()