(function(){"use strict";var e=["P,Pipeline","R,Request Evaluation","Rm,Requirements","C,Concept","D,Development","Dy,Deployment","L,Live"];var t=4;var n={people:{}};var r=false;var i=function(){var t=u(e);$.ajax({type:"POST",url:"server.php",data:{action:"load"},dataType:"json",success:function(e){if(e===null){e={}}n.board=a(e);n.states=t.states;n.states_order=t.states_order;n.rawData=e;h(n);s()}})};var s=function(){var e='<form ><ul class="people-list">';for(var t in n.people){if(n.people.hasOwnProperty(t)){e+='<li><input type="checkbox" name="'+t+'">'+t+"</li>"}}e+="</ul></form>";$("#navigation").append(e)};var o=function(e){if(e===""){e={}}$.ajax({type:"POST",url:"server.php",data:{action:"save",data:e},dataType:"json"})};var u=function(e){var t={};var n=[];for(var r=0,i=e.length;r<i;r++){var s=e[r].split(",");if(s.length===2){t[s[0]]=s[1];n.push(s[0])}}return{states:t,states_order:n}};var a=function(e){var t={};for(var n in e){if(e.hasOwnProperty(n)){var r=e[n];r.id=n;if(!t[r.state]){t[r.state]=[]}t[r.state].push(r)}}return t};var f=function(e){var t=$("<li data-state='"+e.state+"' data-id='"+e.id+"'><div class='box color_"+e.color+"' ><div class='editable' data-id='"+e.id+"'>"+e.title+", "+e.responsible+"</div></div></li>");if(n.people[e.responsible]===undefined){n.people[e.responsible]=[e.id]}else{n.people[e.responsible].push(e.id)}return t};var l=function(e,t){var r=$("<ul></ul>");if(e[t]){for(var i=0,s=e[t].length;i<s;i++){var o=e[t][i].id;var u=f(n.rawData[o]);r.append(u)}}return"<ul class='state' id='"+t+"'>"+r.html()+"</ul>"};var c=function(e,t,n,r){var i='<div class="col state_box state_'+t+" col_"+r+'"><h4>'+n+"</h4>";i+=l(e,t);i+="</div>";return i};var h=function(e){for(var t=0;t<e.states_order.length;t++){var n=e.states_order[t];var r=c(e.board,n,e.states[n],t);$("#board").append(r)}$("ul.state").dragsort({dragSelector:"li",dragBetween:true,placeHolderTemplate:"<li class='placeholder'><div>Â </div></li>",dragEnd:d})};var p=function(e,t,r,i){if(r===undefined){r=n.states_order[0]}if(i===undefined){i=0}var s=t.split(",");if(s.length===1){s[1]="tbd"}var o={title:s[0],id:e,responsible:s[1].replace(/^\s+/,""),state:r,color:i};return o};var d=function(){var e=$(this).parent().attr("id");var t=$(this).attr("data-id");n.rawData[t].state=e;o(n.rawData)};$(document).ready(function(){i();$("#new").click(function(){var e=(new Date).getTime();var t=p(e,"New project");if(n.rawData===undefined){n.rawData={}}n.rawData[e]=t;o(n.rawData);var r=f(t);$("#"+t.state).append(r);return false});$("#board").on("click",".editable",function(){if(!r){var e=$(this).html();var t='<form><input type="text" class="editBox" value="'+e+'" data-old-value="'+e+'"/><br/><a class="save" href="#">save</a> <a class="cancel" href="#">cancel</a> <a href="#" class="delete">delete</a> <a href="#" class="color">color</a></form>';$(this).html(t);r=true}});$("#navigation").on("change",".people-list li",function(){var e=$(this).find("input").attr("name");for(var t in n.people[e]){if($('#board li[data-id="'+n.people[e][t]+'"]').hasClass("highlight")){$('#board li[data-id="'+n.people[e][t]+'"]').removeClass("highlight")}else{$('#board li[data-id="'+n.people[e][t]+'"]').addClass("highlight")}}});$(document).keyup(function(e){if(e.keyCode===27){$(".cancel").trigger("click")}else if(e.keyCode===78){$("#new").trigger("click")}});$("#board").on("click",".cancel",function(){var e=$(this).parent().find("input").attr("data-old-value");$(this).parent().parent().html(e);setTimeout(function(){r=false},200);return false});$("#board").on("click",".delete",function(){var e=$(this).parent().parent().attr("data-id");$(this).parent().parent().parent().parent().remove();delete n.rawData[e];o(n.rawData);setTimeout(function(){r=false},200);return false});$("#board").on("click",".color",function(){var e=$(this).parent().parent().attr("data-id");if(n.rawData[e].color===undefined){n.rawData[e].color=0}else{$(this).parent().parent().parent().removeClass("color_"+n.rawData[e].color);n.rawData[e].color++;if(n.rawData[e].color>=t){n.rawData[e].color=0}}$(this).parent().parent().parent().addClass("color_"+n.rawData[e].color);return false});$("#board").on("submit","form",function(){var e=$(this).find("input").val();var t=$(this).parent().attr("data-id");var i=$(this).parent().parent().parent().attr("data-state");var s=p(t,e,i,n.rawData[t].color);n.rawData[t]=s;o(n.rawData);$(this).parent().html(s.title+", "+s.responsible);setTimeout(function(){r=false},200);return false});$("#board").on("click",".save",function(){$(this).parent().submit();return false})})})()