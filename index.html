<html>
<head>
	<title>Project Dashboard</title>
	<script src="jquery-1.7.1.min.js" type="text/javascript"></script>
	<script type="text/javascript" src="jquery.dragsort-0.5.1.min.js" ></script>
	<link href="reset.css" rel="stylesheet" type="text/css" />
	<link href="style.css" rel="stylesheet" type="text/css" />
	<!--[if lt IE 9]>
	<link rel="stylesheet" type="text/css" href="style-ie7-8.css" />
	<![endif]-->
	<script type="text/javascript">
	var possibleStates = [
		'P,Pipeline',
		'R,Request Evaluation',
		'Rm,Requirements',
		'C,Concept',
		'E,Elaboration',
		'D,Development',
		'Dy,Deployment',
		'L,Live'
	];


	var app_data = {
		people:{}
	};
	
	var IN_EDIT_MODE = false;

	var loadData = function() {
		var state_data = init_states(possibleStates);
		$.ajax({
			type: 'POST',
			url: 'server.php',
			data: {action:'load'},
			dataType: 'json',
			success: function(data) {
				app_data.board = init_board(data);
				app_data.states = state_data.states;
				app_data.states_order = state_data.states_order;
				app_data.rawData = data;

				create_board(app_data);
				createPeopleList();
			}
		});
		//return rawData;
	}

	var createPeopleList = function() {
		console.log(app_data.people);
		var peopleList = '<form ><ul class="people-list">';
		for (var i in app_data.people) {
			peopleList += '<li><input type="checkbox" name="'+i+'">'+i+'</li>';
		}
		peopleList += '</ul></form>';
		$('#navigation').append(peopleList);
	}

	var saveData = function(data) {
		$.ajax({
			type: 'POST',
			url: 'server.php',
			data: {action:'save',data:data},
			dataType:'json'
		});
	}

	var init_states = function(states_input) {
	    var states = {}
		var states_order = []
		for ( var i=0, len=states_input.length; i<len; i++ ) {
			var state = states_input[i].split(",");
			if (state.length == 2) {
				states[state[0]] = state[1];
				states_order.push(state[0]);
			}
		}
	    return {states: states, states_order: states_order};
	}

	var init_board = function(stories) {
		var board = {};
		for (var i in stories) {
			var story = stories[i];
			story.id = i;
			if (! board[story.state]) {
				board[story.state] = [];
			}
			board[story.state].push(story);
		}
		return board;
	}

	var create_story_li_item = function(story) {
		var story_element = $("<li data-state='"+story.state+"' data-id='"+story.id+"'><div class='box' ><div class='editable' data-id='"+story.id+"'>" + story.title + ", " + story.responsible + "</div></div></li>");
		
		if (app_data.people[story.responsible] === undefined) {
			app_data.people[story.responsible] = new Array(story.id);
		}
		else {
			app_data.people[story.responsible].push(story.id);
		}
		return story_element;
	}

	var create_list = function(board, state) {
	   var list = $("<ul></ul>");
       if (board[state]) {
         for (var i=0, len=board[state].length; i<len; i++) {
         	var id = board[state][i]['id'];
            var story_element = create_story_li_item(app_data.rawData[id]);
			list.append(story_element);
     	 }
	   }
	   return "<ul class='state' id='" + state + "'>"+list.html()+"</ul>";
	}

	var create_column = function(board, state, headlines, num) {
		var content = '<div class="col state_box state_'+state+' col_'+num+'"><h4>'+headlines + '</h4>';
		content += create_list(board, state);
		content += '</div>';
		return content;
	}

	var create_board = function(app_data) {
		for (j=0; j< app_data.states_order.length; j++) {
			var state = app_data.states_order[j];
			var col = create_column(app_data.board, state, app_data.states[state],j);
			$('#board').append(col);
		}
		
		$('ul.state').dragsort({dragSelector:'li',dragBetween: true, placeHolderTemplate: "<li class='placeholder'><div>&nbsp;</div></li>",dragEnd:droppedElement});
	}

	var createNewStory = function(id, text, state) {
		if (state === undefined) {
			state = app_data.states_order[0];
		}

		var text = text.split(',');
		if (text.length == 1) {
			text[1] = 'tbd';
		}
		var story = {
			title:text[0],
			id:id,
			responsible:text[1].replace(/^\s+/,''),
			state:state
		};
		return story;
	}

	/**
	* callback when an element has moved
	*/
	var droppedElement = function() {
		var newState = $(this).parent().attr('id');
		var storyId = $(this).attr('data-id');
		app_data.rawData[storyId].state = newState;
		saveData(app_data.rawData);
	}
	


	$(document).ready(function(){
		loadData();

		// ================= Handlers ======================
		
		$('#new').click(function(){
			var id = new Date().getTime();
			story = createNewStory(id, "New project")
			app_data.rawData[id] = story;
			saveData(app_data.rawData);
			var storyHtml = create_story_li_item(story);
			$('#'+story.state).append(storyHtml);
			return false;
		});

		$('#board').on('click','.editable', function(){
			if (!IN_EDIT_MODE) {
				var value = $(this).html();
				var id = $(this).attr('data-id');
				var form = '<form><input type="text" class="editBox" value="'+value+'" data-old-value="'+value+'"/><br/><a class="save" href="#">save</a> <a class="cancel" href="#">cancel</a> <a href="#" class="delete">delete</a></form>';
				$(this).html(form);
				IN_EDIT_MODE = true;
			}
		});

		$('#navigation').on('change', '.people-list li', function(){
			var responsible = $(this).find('input').attr('name');
			console.log(app_data.people[responsible]);
			for (var k in app_data.people[responsible]) {
				if ($('#board li[data-id="'+app_data.people[responsible][k]+'"]').hasClass('highlight')) {
					$('#board li[data-id="'+app_data.people[responsible][k]+'"]').removeClass('highlight');
				}
				else {
					$('#board li[data-id="'+app_data.people[responsible][k]+'"]').addClass('highlight');
				}
				console.log('#board[data-id="'+app_data.people[responsible][k]+'"]');
			}
		});

		$(document).keyup(function(e) {
			if (e.keyCode == 27) { 
				$('.cancel').trigger('click');
			}
		});

		$('#board').on('click','.cancel', function(){
			var oldContent = $(this).parent().find('input').attr('data-old-value');
			$(this).parent().parent().html(oldContent);
			setTimeout(function(){IN_EDIT_MODE = false;}, 200); // need to release a bit later, else we are right back into edit mode again
		});

		$('#board').on('click','.delete', function(){
			var id = $(this).parent().parent().attr('data-id');
			$(this).parent().parent().parent().parent().remove();
			console.log(id);
			delete app_data.rawData[id];
			saveData(app_data.rawData);
			setTimeout(function(){IN_EDIT_MODE = false;}, 200); // need to release a bit later, else we are right back into edit mode again
		});

		$('#board').on('submit', 'form', function(e){
			var title = $(this).find('input').val();
			var storyId = $(this).parent().attr('data-id');
			var state = $(this).parent().parent().parent().attr('data-state');
			var story = createNewStory(storyId, title, state);

			app_data.rawData[storyId] = story;
			saveData(app_data.rawData);

			$(this).parent().html( story.title + ", "+story.responsible);
			setTimeout(function(){IN_EDIT_MODE = false;}, 200); // need to release a bit later, else we are right back into edit mode again
			return false;
		});

		$('#board').on('click','.save', function(e){
			$(this).parent().submit();
			return false;
		});

	});

	</script>
</head>
<body>
	<a href="#" id="new">New</a>
	<div id="board">

	</div>
	<div class="clear"></div>

	<div id="navigation" class="navigation">
		<h5>People with projects</h5>
	</div>
</body>
</html>